# Overview

This repository contains samples for using Azure Stream Analytics to process change data from a relational database (also referred to as change data capture, or CDC) and land it in a target database.
# Scenario

```mermaid
flowchart LR
    subgraph "1. Source (simulated)"
        srcDB[("Source Database")]
        docJSON[/cdc_document.json/]
        coupJSON[/cdc_coupon.json/]
    end
    subgraph 2. Stream Ingestion Layer
        docEH[Document Event Hub]
        coupEH[Coupon Event Hub]
    end
    subgraph 3. Stream Processing Layer
        docStream[Document Stream]
        coupStream[Coupon Stream]
        docJob[3.1 Document Streaming Job]
        coupJob[3.2 Coupon Streaming Job]  
    end
    subgraph 4. Target Database
        docTable[Document Table]
        coupTable[Coupon Table]
    end
    srcDB --> docJSON & coupJSON
    docJSON --> docEH
    coupJSON --> coupEH
    docEH --> docStream
    coupEH --> coupStream
    docStream --> docJob
    docStream & coupStream --> coupJob
    docJob --> docTable
    coupJob --> coupTable
```

1. Simulated change data (in JSON format) being generated by a source database. CDC data will be generated for two related tables: **document** and **coupon**
2. The simulated change data for each table will be sent to respective Azure Event Hubs for fast ingestion.
3. Azure Stream Analytics input streams will read from the corresponding Event Hubs
    1. One ASA job will process the document stream, creating a derived column (concatenation of **documentId** and the document **createDatetime**) which will be used as a new primary key in the target database.
    2. Another ASA job will process the coupon stream, adding a reference to the newly-created document primary key as a foreign key.
4. Each of the stream processing services will write to the corresponding target table in the target database.